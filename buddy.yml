- pipeline: "build android"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "main"
  ref_type: "BRANCH"
  fail_on_prepare_env_warning: true
  trigger_condition: "ALWAYS"
  actions:
    - action: "Execute: ./gradlew bundleRelease assembleRelease"
      type: "BUILD"
      working_directory: "/buddy/react-native-ci-cd-compare"
      docker_image_name: "library/openjdk"
      docker_image_tag: "8"
      execute_commands:
        - "export ANDROID_HOME=\"/opt/android/sdk/\""
        - "export BUILD_TOOLS_VER=\"28.0.3\""
        - "export PATH=$PATH:/opt/android/sdk/build-tools/$BUILD_TOOLS_VER"
        - "#build"
        - "npm i -g yarn"
        - "yarn install --frozen-lockfile"
        - "cd ./android"
        - "chmod +x gradlew"
        - "./gradlew bundleRelease assembleRelease"
      setup_commands:
        - "mkdir -p /opt/android/sdk && mkdir .android"
        - "cd /opt/android/sdk && curl -o sdk.zip https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip && unzip sdk.zip && rm sdk.zip"
        - "yes | /opt/android/sdk/tools/bin/sdkmanager --licenses"
        - "/opt/android/sdk/tools/bin/sdkmanager --update > /dev/null"
        - "/opt/android/sdk/tools/bin/sdkmanager platform-tools > /dev/null"
        - "/opt/android/sdk/tools/bin/sdkmanager tools > /dev/null"
        - "/opt/android/sdk/tools/bin/sdkmanager emulator > /dev/null"
        - "/opt/android/sdk/tools/bin/sdkmanager \"extras;android;m2repository\" > /dev/null"
        - "/opt/android/sdk/tools/bin/sdkmanager \"extras;google;m2repository\" > /dev/null"
        - "/opt/android/sdk/tools/bin/sdkmanager \"extras;google;google_play_services\" > /dev/null"
        - "/opt/android/sdk/tools/bin/sdkmanager \"build-tools;28.0.3\" > /dev/null"
        - "/opt/android/sdk/tools/bin/sdkmanager \"platforms;android-29\" > /dev/null"
        - "# install nodejs"
        - "curl -sL https://deb.nodesource.com/setup_12.x | bash -"
        - "apt-get install -y nodejs"
      cached_dirs:
        - "/root/.gradle"
      volume_mappings:
        - "/:/buddy/react-native-ci-cd-compare"
      trigger_condition: "ALWAYS"
      shell: "BASH"
